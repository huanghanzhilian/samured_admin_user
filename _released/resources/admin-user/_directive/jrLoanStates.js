define(["app","directive/jrPlaceholder","directive/jrCheckbox","model/orderStatesModel","model/orderRejectReasonModel"],function(app){app.registerDirective("jrLoanStates",["$http","$modal","orderStatesModel","orderRejectReasonModel",function($http,$modal,orderStatesModel,orderRejectReasonModel){function rejectModal($scope,modalTpl,option,title,reasons){var modalStatesReject=$modal.open({template:modalTpl,controller:"ModalStatesReject",backdrop:"static",resolve:{items:function(){return $.extend(!0,[],reasons)},title:function(){return title}}});modalStatesReject.result.then(function(reasonStr){updateState($scope,option,{note:reasonStr})})}function confirmModal($scope,modalTpl,option,title){var modalStatesReject=$modal.open({template:modalTpl,controller:"ModalStatesConfirm",backdrop:"static",resolve:{datainfo:function(){return $scope.datainfo},title:function(){return title}}});modalStatesReject.result.then(function(postData){updateState($scope,option,postData)})}function updateState($scope,option,additionParams){$http.post("/rs/admin/updateState",$.param($.extend({orderId:$scope.dataid,checkState:option.value},additionParams))).success(function(){$scope.displayName=option.name,$scope.value=option.value,setOptions($scope),additionParams&&additionParams.note&&($scope.datainfo.note=additionParams.note)})}function setOptions($scope){switch($scope.options=[],$scope.value){case"1":$scope.options=$scope.options.concat(ORDER_STATES.slice(1));break;case"2":$scope.options=$scope.options.concat(ORDER_STATES.slice(4,6),ORDER_STATES.slice(7));break;case"3":$scope.options=$scope.options.concat(ORDER_STATES.slice(2,3),ORDER_STATES.slice(4,6),ORDER_STATES.slice(7));break;case"4":$scope.options=$scope.options.concat(ORDER_STATES.slice(3,4),ORDER_STATES.slice(5,6),ORDER_STATES.slice(7));break;case"5":$scope.options=$scope.options.concat(ORDER_STATES.slice(3,5),ORDER_STATES.slice(7,8));break;default:$scope.disabled=!0}}var ORDER_STATES=[""].concat(orderStatesModel),rejectTpl='<div class="modal-header">\r\n    <a href="javascript:void(0)" ng-click="$dismiss(\'cancel\')" class="modal-close"></a>\r\n    <h3 class="modal-title">{{title}}:</h3>\r\n</div>\r\n<form name="rejectForm" novalidate ng-submit="submit()">\r\n<div class="modal-body">\r\n    <table class="lh-2-5">\r\n        <tbody>\r\n            <tr ng-repeat="reason in reasons">\r\n                <td ng-repeat="item in reason"><jr-checkbox checked="item.checked" text="{{item.text}}"></jr-checkbox></td>\r\n            </tr>\r\n            <tr>\r\n                <td colspan="2"><textarea class="form-modal mt-s" rows="2" ng-model="addition.text" jr-placeholder="其他理由补充说明,100个字以内" maxlength="100"></textarea></td>\r\n            </tr>\r\n        </tbody>\r\n    </table>\r\n</div>\r\n<div class="modal-footer">\r\n    <span class="error-info">{{errorInfo}}</span>\r\n    <button class="btn btn-primary btn-submit" type="submit">提交</button>\r\n</div>\r\n</form>',confirmTpl='<div class="modal-header">\r\n    <a href="javascript:void(0)" ng-click="$dismiss(\'cancel\')" class="modal-close"></a>\r\n    <h3 class="modal-title">{{title}}:</h3>\r\n</div>\r\n<div class="modal-body">\r\n    <form name="confirmForm" novalidate ng-submit="submit()">\r\n    <table class="lh-2-5">\r\n        <colgroup>\r\n            <col width="90"/>\r\n            <col width="110"/>\r\n            <col width="60"/>\r\n            <col width="110"/>\r\n        </colgroup>\r\n        <tbody>\r\n            <tr>\r\n                <td>产<span class="gap-2_3w"></span>品<span class="gap-2_3w"></span>名<span class="gap-2_3w"></span>称:</td>\r\n                <td>{{datainfo.productName}}</td>\r\n                <td>所<span class="gap-1_2w"></span>在<span class="gap-1_2w"></span>地:</td>\r\n                <td>{{datainfo.applyCity}}</td>\r\n            </tr>\r\n            <tr>\r\n                <td>借<span class="gap-3_2w"></span>款<span class="gap-3_2w"></span>人:</td>\r\n                <td>{{datainfo.userName}}</td>\r\n                <td>借款类型:</td>\r\n                <td>{{datainfo.loanType}}</td>\r\n            </tr>\r\n            <tr>\r\n                <td>借<span class="gap-2_3w"></span>款<span class="gap-2_3w"></span>金<span class="gap-2_3w"></span>额:</td>\r\n                <td>{{datainfo.applyLoanAmount}}万元</td>\r\n                <td>借款期限:</td>\r\n                <td>{{datainfo.applyLoanMonth}}个月</td>\r\n            </tr>\r\n            <tr>\r\n                <td>实际批贷金额:</td>\r\n                <td colspan="3" class="pt pb">\r\n                    <span class="error-info pull-right mr-s" ng-if="confirmForm.sucLoanAmount.$invalid">实际金额应为有效数字</span>\r\n                    <span class="error-info pull-right mr-s" ng-if="confirmForm.sucLoanAmount.$valid && confirmForm.sucLoanMonth.$invalid">实际期限应为整数</span>\r\n                    <input type="text" class="form-modal w80 pull-left" name="sucLoanAmount" ng-model="postData.sucLoanAmount" ng-required="true" ng-pattern="/^\\d{1,4}(\\.\\d{0,2})?$/" />&nbsp;万元\r\n                </td>\r\n            </tr>\r\n            <tr>\r\n                <td>实<span class="gap-2_3w"></span>际<span class="gap-2_3w"></span>期<span class="gap-2_3w"></span>限:</td>\r\n                <td colspan="2" class="pt pb">\r\n                    <input type="text" class="form-modal w80 pull-left" name="sucLoanMonth" ng-model="postData.sucLoanMonth" ng-required="true" maxlength="3" ng-pattern="/^\\d{1,3}$/" />&nbsp;月 {{realLoanMonth}}\r\n                </td>\r\n                <td>\r\n                    <button class="btn btn-primary pull-right btn-submit" type="submit" ng-disabled="confirmForm.$invalid">提交</button>\r\n                </td>\r\n            </tr>\r\n        </tbody>\r\n    </table>\r\n    </form>\r\n</div>';return{restrict:"E",replace:!0,template:'<div class="btn-group dropdown-btn">\r\n    <button type="button" class="btn dropdown-toggle {{theme || \'btn-default\'}}" data-toggle="dropdown" ng-disabled="disabled">\r\n        {{displayName}}\r\n        <span class="caret"></span>\r\n    </button>\r\n    <ul class="dropdown-menu" role="menu">\r\n        <li ng-repeat="option in options"><a ng-click="selcet(option)">{{option.name || option}}</a></li>\r\n    </ul>\r\n</div>',scope:{dataid:"@",theme:"@",selected:"=",value:"=",datainfo:"="},link:function($scope){$scope.displayName=ORDER_STATES[$scope.value].name,setOptions($scope),$scope.selcet=function(option){var modalTpl,reasons,title;switch(option.value){case"4":modalTpl=confirmTpl,title="批核确认",confirmModal($scope,modalTpl,option,title);break;case"5":modalTpl=rejectTpl,reasons=orderRejectReasonModel.get(option.value),title="贷款取消理由",rejectModal($scope,modalTpl,option,title,reasons);break;case"6":modalTpl=rejectTpl,reasons=orderRejectReasonModel.get(option.value),title="退件理由",rejectModal($scope,modalTpl,option,title,reasons);break;case"7":modalTpl=rejectTpl,reasons=orderRejectReasonModel.get(option.value),title="审批拒绝理由",rejectModal($scope,modalTpl,option,title,reasons);break;case"8":modalTpl=confirmTpl,title="放款确认",confirmModal($scope,modalTpl,option,title);break;default:updateState($scope,option)}}}}}]),app.registerController("ModalStatesReject",function($scope,$modalInstance,items,title){$scope.reasons=items,$scope.title=title,$scope.addition={text:void 0},$scope.submit=function(){for(var selectedReasons=[],i=0;i<$scope.reasons.length;i++)for(var j=0;j<$scope.reasons[i].length;j++)$scope.reasons[i][j].checked&&selectedReasons.push($scope.reasons[i][j].text);if($.trim($scope.addition.text)){if($.trim($scope.addition.text).length>100)return $scope.errorInfo="补充说明不能超过100个字",!1;selectedReasons.push($scope.addition.text)}selectedReasons.length?$modalInstance.close(selectedReasons.join(";")):$scope.errorInfo="请选择或填写理由"}}),app.registerController("ModalStatesConfirm",function($scope,$modalInstance,datainfo,title){$scope.datainfo=datainfo,$scope.title=title,$scope.postData={sucLoanAmount:datainfo.applyLoanAmount,sucLoanMonth:datainfo.applyLoanMonth},$scope.submit=function(){$modalInstance.close($scope.postData)}})});