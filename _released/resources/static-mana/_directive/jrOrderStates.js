define(["app","directive/jrPlaceholder","directive/jrCheckbox","model/orderStatesModel"],function(app){app.registerDirective("jrOrderStates",["$http","$modal","orderStatesModel",function($http,$modal,orderStatesModel){function rejectModal($scope,modalTpl,option,title,reasons){var modalStatesReject=$modal.open({template:modalTpl,controller:"ModalStatesReject",backdrop:"static",resolve:{items:function(){return $.extend(!0,[],reasons)},title:function(){return title}}});modalStatesReject.result.then(function(reasonStr){updateState($scope,option,{reason:reasonStr})})}function updateState($scope,option,additionParams){$http.post("/rs/manage/examinehouseinfo",$.param($.extend({orderId:$scope.dataid,pass:"2"===option.value.toString()},additionParams))).success(function(){$scope.displayName=option.name,$scope.value=option.value,setOptions($scope)})}function setOptions($scope){switch($scope.options=[],$scope.value.toString()){case"1":$scope.options=$scope.options.concat(ORDER_STATES.slice(2));break;default:$scope.disabled=!0}}var ORDER_STATES=[""].concat(orderStatesModel),rejectTpl='<div class="modal-header">\r\n    <a href="javascript:void(0)" ng-click="$dismiss(\'cancel\')" class="modal-close"></a>\r\n    <h3 class="modal-title">{{title}}:</h3>\r\n</div>\r\n<form name="rejectForm" novalidate ng-submit="submit()">\r\n<div class="modal-body">\r\n    <table class="lh-2-5">\r\n        <tbody>\r\n            <tr ng-repeat="reason in reasons">\r\n                <td ng-repeat="item in reason"><jr-checkbox checked="item.checked" text="{{item.text}}"></jr-checkbox></td>\r\n            </tr>\r\n            <tr>\r\n                <td colspan="2"><textarea class="form-modal mt-s" rows="2" ng-model="addition.text" jr-placeholder="其他理由补充说明,100个字以内" maxlength="100"></textarea></td>\r\n            </tr>\r\n        </tbody>\r\n    </table>\r\n</div>\r\n<div class="modal-footer">\r\n    <span class="error-info">{{errorInfo}}</span>\r\n    <button class="btn btn-primary btn-submit" type="submit">提交</button>\r\n</div>\r\n</form>';return{restrict:"E",replace:!0,template:'<div class="btn-group dropdown-btn">\r\n    <button type="button" class="btn dropdown-toggle {{theme || \'btn-default\'}}" data-toggle="dropdown" ng-disabled="disabled">\r\n        {{displayName}}\r\n        <span class="caret"></span>\r\n    </button>\r\n    <ul class="dropdown-menu" role="menu">\r\n        <li ng-repeat="option in options"><a ng-click="selcet(option)">{{option.name || option}}</a></li>\r\n    </ul>\r\n</div>',scope:{dataid:"@",theme:"@",selected:"=",value:"=",datainfo:"="},link:function($scope){$scope.displayName=ORDER_STATES[$scope.value].name,setOptions($scope),$scope.selcet=function(option){var modalTpl,reasons,title;switch(option.value.toString()){case"2":confirm("确认该用户审核通过")&&updateState($scope,option);break;case"3":modalTpl=rejectTpl,title="审核不通过理由",rejectModal($scope,modalTpl,option,title,reasons);break;default:updateState($scope,option)}}}}}]),app.registerController("ModalStatesReject",function($scope,$modalInstance,items,title){$scope.reasons=items,$scope.title=title,$scope.addition={text:void 0},$scope.submit=function(){for(var selectedReasons=[],i=0;i<$scope.reasons.length;i++)for(var j=0;j<$scope.reasons[i].length;j++)$scope.reasons[i][j].checked&&selectedReasons.push($scope.reasons[i][j].text);if($.trim($scope.addition.text)){if($.trim($scope.addition.text).length>100)return $scope.errorInfo="补充说明不能超过100个字",!1;selectedReasons.push($scope.addition.text)}selectedReasons.length?$modalInstance.close(selectedReasons.join(";")):$scope.errorInfo="请选择或填写理由"}}),app.registerController("ModalStatesConfirm",function($scope,$modalInstance,datainfo,title){$scope.datainfo=datainfo,$scope.title=title,$scope.postData={sucLoanAmount:datainfo.applyLoanAmount,sucLoanMonth:datainfo.applyLoanMonth},$scope.submit=function(){$modalInstance.close($scope.postData)}})});