define(["app"],function(app){app.registerDirective("ngThumb",["$window","$compile",function($window,$compile){var helper={support:!(!$window.FileReader||!$window.CanvasRenderingContext2D),isFile:function(item){return angular.isObject(item)&&item instanceof $window.File},isImage:function(file){var type="|"+file.type.slice(file.type.lastIndexOf("/")+1)+"|";return-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(type)}},zoomer=null,zoomwp=null,_playZoomer=function(scope,index){var $win=angular.element($window),queue=scope.item.uploader.queue,item=queue[index],win_height=$win.height(),win_width=$win.width(),width=item.width,height=item.height;(item.width>win_width||item.height>win_height)&&(item.width/item.height>win_width/win_height?(width=win_width,height=width/item.width*item.height):(height=win_height,width=height/item.height*item.width));var offset_left=(win_width-width)/2,offset_top=(win_height-height)/2;item._width=width,item._height=height,item._offset_left=offset_left,item._offset_top=offset_top,scope.flag=0==index?0:2;var size=queue.length;size==index+1&&(scope.flag=3),1==size&&(scope.flag=-1);var _width=item._width,_height=item._height,_src=item.src;item=scope.item;var content=angular.element('<div class="content"><img style="width:'+_width+"px;height:"+_height+'px;" src="'+_src+'" /></div>');content.css({width:width,height:height,left:offset_left,top:offset_top}).show(),$("#zoom").size()>0?(zoomer=$compile($.parseHTML('<div id="zoom" class="zoom" ng-click="hideZoomer($event, item)"><a class="close"></a><a ng-show="flag>0" href="javascript:;" ng-click="playZoomer($event, '+index+', 0)" class="previous"></a><a ng-show="flag<3&&flag>-1" href="javascript:;" ng-click="playZoomer($event, '+index+', 1)" class="next"></a></div>'))(scope),zoomer.show(),zoomer.append(content),zoomwp.html(zoomer)):($body=angular.element("body"),zoomwp=angular.element('<div class="zoomer"></div>'),zoomer=$compile($.parseHTML('<div id="zoom" class="zoom" ng-click="hideZoomer($event, item)"><a class="close"></a><a ng-show="flag>0 " href="javascript:;" ng-click="playZoomer($event, '+index+', 0)" class="previous"></a><a ng-show="flag<3&&flag>-1" href="javascript:;" ng-click="playZoomer($event, '+index+', 1)" class="next"></a></div>'))(scope),zoomer.show(),zoomer.append(content),zoomwp.html(zoomer),$body.append(zoomwp))};return{restrict:"A",replace:!0,template:"<img/>",link:function(scope,element,attributes){function onLoadImage(event){var img=event.target;if(scope.item.src=img.src,scope.item.width=img.width,scope.item.height=img.height,img.width/img.height>1.25)var width=125,height=width/img.width*img.height;else var height=100,width=height/img.height*img.width;element.css("height",height),element.css("width",width),element.attr("src",img.src+"?w=125")}function onLoadFile(event){var img=new Image;img.onload=onLoadImage,img.src=event.target.result}if(helper.support){scope.flag=0;var params=scope.$eval(attributes.ngThumb),file=params.file;if(file.attachmentUrl){var img=new Image;img.onload=onLoadImage,scope.item.src=img.src=file.attachmentUrl}else{if(!helper.isFile(params.file))return;if(!helper.isImage(params.file))return;var reader=new FileReader;reader.onload=onLoadFile,reader.readAsDataURL(params.file)}element.click(function(){var queue=scope.item.uploader.queue,index=queue.indexOf(scope.item);_playZoomer(scope,index),scope.$apply(function(){scope.flag=scope.flag})}),scope.hideZoomer=function(){zoomer.hide()},scope.playZoomer=function(event,index,type){event.stopPropagation(),event.preventDefault();var queue=scope.item.uploader.queue;if(0==type){if(0==index)return;_playZoomer(scope,index-1)}else if(1==type){if(index==queue.length-1)return;_playZoomer(scope,index+1)}}}}}}])});