var app=angular.module("app",["ui.bootstrap","ui.bootstrap.tpls"]);!function(app){function getUrlParam(name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)"),r=window.location.search.substr(1).match(reg);return null!=r?unescape(r[2]):null}app.directive("jrPlaceholder",[function(){return{restrict:"A",require:"^ngModel",link:function($scope,element,attrs,ctrl){if("placeholder"in document.createElement("input"))element.attr("placeholder",attrs.jrPlaceholder);else{var value,placehold=function(){element.val(attrs.jrPlaceholder),element.addClass("placeholder-ie")},unplacehold=function(){element.val(""),element.removeClass("placeholder-ie")};$scope.$watch(attrs.ngModel,function(val){value=val||""}),element.on("focus",function(){""===value&&unplacehold()}),element.on("blur",function(){""===element.val()&&placehold()}),ctrl.$formatters.unshift(function(val){return val?val:(placehold(),value="",attrs.jrPlaceholder)})}}}}]),app.controller("CtrlLogin",["$scope","$http","$location","$modal",function($scope,$http,$location,$modal){$location.search().error&&($scope.verif="/rs/manage/authCode?"+(new Date).getTime()),setTimeout(function(){$scope.loginData={optDesc:"用户登录",userName:$("#username").val(),password:$("#password").val()}},500),$scope.blur=function(){$scope.loginData.password!==$("#password").val()&&($scope.loginData.password=$("#password").val())},$scope.enter=function($event){13===$event.keyCode&&$scope.loginData.password!==$("#password").val()&&($scope.loginData.password=$("#password").val())},$scope.refresh=function(){$scope.verif="/rs/manage/authCode?"+(new Date).getTime()},$scope.login=function(){function loginSuccess(){++loginCount>1&&(location.href="/manage/index")}$scope.loginData.password=$.fn.md5($scope.loginData.password),$http({method:"POST",url:"/manage/white/json/get/checklogin",data:$.param($scope.loginData),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Requested-With":"XMLHttpRequest"}}).success(function(data){data.success?(loginSuccess(),location.href=getUrlParam("referrer")?getUrlParam("referrer")+location.hash:"/manage/index"+location.hash):$scope.loginForm.errorInfo=data.message,1==data.requestParams.auth&&($location.search("error","true"),$scope.verif="/rs/manage/authCode?"+(new Date).getTime())}).error(function(){$scope.loginForm.errorInfo="网络错误,请检查网络连接"});var loginCount=0},$scope.findpwd=function(){step1()};var step1=function(){var modaladdConfig=$modal.open({template:'<div class="modal-header">\r\n    <a href="javascript:void(0)" ng-click="$dismiss(\'cancel\')" class="modal-close"></a>\r\n    <h3 class="modal-title">找回密码</h3>\r\n</div>\r\n<form name="addConfigForm" novalidate  class="modify-agent-info">\r\n    <div class="modal-body">\r\n        <div class="input-group first-group">\r\n            <span class="input-group-addon usericon"></span>\r\n            <input id="userName" type="text" ng-model="data.userName" name="userName" autocomplete="off" class="form-control" ng-required="true" jr-placeholder="请输入用户名/法人手机号"  />\r\n        </div>\r\n        <div class="input-group first-group" style="padding-top: 20px;">\r\n            <p style="text-align: center;padding-top: 10px;padding-left: 35px;" class="error-info" ng-bind="errorInfo"></p>\r\n        </div>\r\n        <div style="margin-top: 20px;text-align: center;">\r\n            <button class="btn btn-primary btn-submit" style="width: 150px;" ng-disabled="addConfigForm.$invalid" ng-click="submit()" type="submit">下一步</button>\r\n        </div>\r\n    </div>\r\n</form>',controller:function($scope){$scope.data={userName:""},$scope.errorInfo="",$scope.submit=function(){$scope.errorInfo="",$http({method:"POST",url:"/rs/manage/checkuser",data:$.param({userName:$scope.data.userName}),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Requested-With":"XMLHttpRequest"}}).success(function(data){data.success?(step2(data.object.userName,data.object.phone),$scope.$dismiss("cancel")):$scope.errorInfo=data.message}).error(function(){$scope.errorInfo="网络错误,请检查网络连接"})}},backdrop:"static",resolve:{status:function(){return status}}});modaladdConfig.result.then(function(){})},step2=function(userName,phone){var modaladdConfig=$modal.open({template:'<div class="modal-header">\r\n    <a href="javascript:void(0)" ng-click="$dismiss(\'cancel\')" class="modal-close"></a>\r\n    <h3 class="modal-title">找回密码</h3>\r\n</div>\r\n<form name="addConfigForm" novalidate  class="modify-agent-info">\r\n    <div class="modal-body" style="padding: 10px 10px;">\r\n        <div class="input-group first-group" style="margin-top: 10px;">\r\n            <div class="input-group-addon" style="background-color: #fff;border: 0;width: 120px;">用户名</div>\r\n            <input id="userName" type="text" ng-model="data.userName" name="userName" style="width: 140px;" class="form-control" disabled="disabled"  />\r\n        </div>\r\n        <div class="input-group first-group" style="margin-top: 10px;">\r\n            <div class="input-group-addon" style="background-color: #fff;border: 0;width: 120px;">法人手机号码</div>\r\n            <input type="text" ng-model="data.phone" autocomplete="off" class="form-control" disabled="disabled" style="width: 140px;margin-right: 10px;"   />\r\n            <button id="getPhonePin" class="btn btn-primary" ng-click="getPhonePin()">获取验证码</button>\r\n        </div>\r\n        <div style="text-align: center;margin-top: 10px;display: none;" id="pin">\r\n            <p><span id="pintext">180</span>秒，重发手机确认码</p>\r\n            <p>确认码短信已经发到您的手机，请查收！</p>\r\n        </div>\r\n        <div class="input-group first-group" style="margin-top: 10px;">\r\n            <div class="input-group-addon" style="background-color: #fff;border: 0;width: 120px;">手机验证码</div>\r\n            <input type="text" ng-model="data.phonePin" style="width: 140px;" class="form-control" ng-required="true"  />\r\n        </div>\r\n        <div class="input-group first-group" style="margin-top: 10px;">\r\n            <div class="input-group-addon" style="background-color: #fff;border: 0;width: 120px;">请输入新密码</div>\r\n            <input type="password" ng-model="data.password" style="width: 140px;" class="form-control" ng-required="true"  />\r\n        </div>\r\n        <div class="input-group first-group" style="margin-top: 10px;">\r\n            <div class="input-group-addon" style="background-color: #fff;border: 0;width: 120px;">再次输入新密码</div>\r\n            <input type="password" ng-model="data.confirmPassword" style="width: 140px;" class="form-control" ng-required="true"  />\r\n        </div>\r\n        <div class="input-group first-group" style="padding-top: 20px;">\r\n            <p style="margin-left: 10px;" class="error-info" ng-bind="errorInfo"></p>\r\n        </div>\r\n    </div>\r\n    <div class="modal-footer">\r\n        <button class="btn btn-primary btn-submit" ng-disabled="addConfigForm.$invalid" ng-click="submit()" type="submit">确定</button>\r\n        <button class="btn btn-cancel" ng-click="$dismiss(\'cancel\')" >取消</button>\r\n    </div>\r\n</form>',controller:function($scope){$scope.data={userName:userName,phone:phone,phonePin:"",password:"",confirmPassword:""},$scope.errorInfo="",$scope.djs=function(num){var djs=num;$("#getPhonePin").attr("disabled","disabled"),$("#pin").show();var _sync=function(){djs>0?($("#pintext").text(djs),djs--,setTimeout(function(){_sync()},1e3)):($("#pin").hide(),$("#getPhonePin").removeAttr("disabled"))};_sync()},$scope.getPhonePin=function(){$scope.errorInfo="",$http({method:"POST",url:"/rs/manage/getPhonePIN",data:$.param({userName:$scope.data.userName,phone:$scope.data.phone}),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Requested-With":"XMLHttpRequest"}}).success(function(data){data.success?$scope.djs(180):$scope.errorInfo=data.message}).error(function(){$scope.errorInfo="网络错误,请检查网络连接"})},$scope.submit=function(){return $scope.errorInfo="",$scope.data.password!=$scope.data.confirmPassword?void($scope.errorInfo="两次密码输入不一致"):void $http({method:"POST",url:"/rs/manage/findMyPassword",data:$.param({userName:$scope.data.userName,phone:$scope.data.phone,phonePin:$scope.data.phonePin,password:$scope.data.password,confirmPassword:$scope.data.confirmPassword,optDesc:"获取初始密码"}),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Requested-With":"XMLHttpRequest"}}).success(function(data){data.success?(step3(),$scope.$dismiss("cancel")):$scope.errorInfo=data.message}).error(function(){$scope.errorInfo="网络错误,请检查网络连接"})}},backdrop:"static",resolve:{status:function(){return status}}});modaladdConfig.result.then(function(){})},step3=function(){var modaladdConfig=$modal.open({template:'<div class="modal-header">\r\n    <a href="javascript:void(0)" ng-click="$dismiss(\'cancel\')" class="modal-close"></a>\r\n    <h3 class="modal-title">找回密码</h3>\r\n</div>\r\n<form name="addConfigForm" novalidate  class="modify-agent-info">\r\n    <div class="modal-body">\r\n\r\n        <div class="input-group first-group">\r\n            <p style="text-align: center;padding-top: 10px;padding-left: 35px;" class="error-info">恭喜您，密码修改成功，请注意保存。</p>\r\n        </div>\r\n    </div>\r\n    <div class="modal-footer">\r\n        <button class="btn btn-cancel" ng-click="$dismiss(\'cancel\')" >关闭</button>\r\n    </div>\r\n</form>',controller:function(){},backdrop:"static",resolve:{status:function(){return status}}});modaladdConfig.result.then(function(){})},verifyCodeUrl="/rs/user/verifyCode?_=";$scope.uncacheVerifyCodeUrl=verifyCodeUrl+(new Date).getTime(),$scope.changeCode=function(){$scope.uncacheVerifyCodeUrl=verifyCodeUrl+(new Date).getTime()}}])}(app);